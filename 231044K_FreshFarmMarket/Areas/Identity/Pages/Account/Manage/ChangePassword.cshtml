@page
@model ChangePasswordModel
@{
    ViewData["Title"] = "Change password";
    ViewData["ActivePage"] = ManageNavPages.ChangePassword;
}

<h3>@ViewData["Title"]</h3>

<partial name="_StatusMessage" for="StatusMessage" />

<div class="row">
    <div class="col-md-6">

        <form id="change-password-form" method="post">

            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            <!-- Current Password -->
            <div class="form-floating mb-3">
                <input asp-for="Input.OldPassword"
                       class="form-control"
                       autocomplete="current-password"
                       aria-required="true"
                       placeholder="Please enter your old password." />
                <label asp-for="Input.OldPassword"></label>
                <span asp-validation-for="Input.OldPassword" class="text-danger"></span>
            </div>

            <!-- New Password -->
            <div class="form-floating mb-3">
                <input asp-for="Input.NewPassword"
                       id="newPw"
                       class="form-control"
                       autocomplete="new-password"
                       aria-required="true"
                       placeholder="Please enter your new password." />
                <label asp-for="Input.NewPassword"></label>
                <span asp-validation-for="Input.NewPassword" class="text-danger"></span>
            </div>

            <!-- Password Strength UI -->
            <div class="mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Password strength</small>
                    <span id="pwStrengthLabel" class="badge bg-secondary">-</span>
                </div>

                <div class="progress mb-2" style="height:10px;">
                    <div id="pwStrengthBar"
                         class="progress-bar"
                         role="progressbar"
                         style="width:0%"></div>
                </div>

                <ul class="small mb-0" style="padding-left:1.2rem;">
                    <li id="reqLen">At least 12 characters</li>
                    <li id="reqLower">At least 1 lowercase letter</li>
                    <li id="reqUpper">At least 1 uppercase letter</li>
                    <li id="reqDigit">At least 1 number</li>
                    <li id="reqSpecial">At least 1 special character</li>
                </ul>
            </div>

            <!-- Confirm Password -->
            <div class="form-floating mb-3">
                <input asp-for="Input.ConfirmPassword"
                       class="form-control"
                       autocomplete="new-password"
                       aria-required="true"
                       placeholder="Please confirm your new password." />
                <label asp-for="Input.ConfirmPassword"></label>
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
            </div>

            <button type="submit" class="w-100 btn btn-lg btn-primary">
                Update password
            </button>

        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // ===== Password strength logic (client-side feedback) =====
        const pwInput = document.getElementById("newPw");
        const label = document.getElementById("pwStrengthLabel");
        const bar = document.getElementById("pwStrengthBar");

        const reqLen = document.getElementById("reqLen");
        const reqLower = document.getElementById("reqLower");
        const reqUpper = document.getElementById("reqUpper");
        const reqDigit = document.getElementById("reqDigit");
        const reqSpecial = document.getElementById("reqSpecial");

        function setReq(el, ok) {
            el.style.fontWeight = ok ? "600" : "400";
            el.style.color = ok ? "#198754" : "#6c757d";
        }

        function updateStrength(pw) {
            const hasLen = pw.length >= 12;
            const hasLower = /[a-z]/.test(pw);
            const hasUpper = /[A-Z]/.test(pw);
            const hasDigit = /[0-9]/.test(pw);
            const hasSpecial = /[^A-Za-z0-9]/.test(pw);

            setReq(reqLen, hasLen);
            setReq(reqLower, hasLower);
            setReq(reqUpper, hasUpper);
            setReq(reqDigit, hasDigit);
            setReq(reqSpecial, hasSpecial);

            const score = [hasLen, hasLower, hasUpper, hasDigit, hasSpecial].filter(Boolean).length;
            const percent = (score / 5) * 100;

            bar.style.width = percent + "%";

            if (!pw) {
                label.textContent = "-";
                label.className = "badge bg-secondary";
                return;
            }

            if (score <= 2) {
                label.textContent = "Weak";
                label.className = "badge bg-danger";
            } else if (score <= 4) {
                label.textContent = "Medium";
                label.className = "badge bg-warning text-dark";
            } else {
                label.textContent = "Strong";
                label.className = "badge bg-success";
            }
        }

        pwInput?.addEventListener("input", e => updateStrength(e.target.value));
        updateStrength(pwInput?.value || "");
    </script>
}
